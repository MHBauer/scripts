# To build a Docker Dojo VM
# - download the Ubuntu Desktop image - e.g. ubuntu-16.04.1-desktop-amd64.iso
# - create a Vbox VM:
#   - 2 gig memory
#   - 2 CPU
#   - 20 gig disk
#   - attach ISO
# - during install of Ubuntu
#   - select "Download updates while installing Ubuntu"
#   - Erase disk and install Ubuntu
#   - Name: docker
#   - Computer Name: docker
#   - username: user
#   - password: docker
#   - select: log in automatically
#
# Then run the VM:
# - Remove extra icons from the launch bar
# - Add terminal to launch bar
# - Enable copy-n-paste
# - Insert the Guest Additions CD, run, eject
# - Reboot
# - Run:
#     curl -s https://raw.githubusercontent.com/ibm-dojo/scripts/master/dojoInstall | bash

set -ex

user="user"

# Update OS stuff
#################
sudo apt-get update
sudo apt-get -y upgrade
sudo apt-get install -y curl

# Install Docker
################
if ! which docker > /dev/null ; then
    sudo curl -fsSL https://get.docker.com/ | sh
    sudo usermod -aG docker $user

	# verify
    docker version
fi

# Install the desired version of Docker
#######################################
sudo service docker stop
dockerVersion=1.12.0
dockerDir=$(dirname `which docker`)
sudo mkdir ${dockerDir}/saved.docker
sudo mv ${dockerDir}/docker* ${dockerDir}/saved.docker/
curl -s https://get.docker.com/builds/Linux/x86_64/docker-$dockerVersion.tgz | \
	sudo tar -C ${dockerDir} --strip-components=1 -xvzf-
sudo service docker start

# Run the Dojo setup script
# Have to 'sudo -u user' to pick up the new group perms
#######################################################
if ! which dojoPrep > /dev/null; then
    curl -s \
	  https://raw.githubusercontent.com/ibm-dojo/scripts/master/dojoPrep | 
	  sudo -u user bash
else
	sudo -u user dojoPrep
fi
